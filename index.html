<!doctype html>
<html lang="ms" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JF Wadi Group - Sistem Tempahan Penginapan</title>
    <link rel="icon" type="image/x-icon" href="jfwadigroupicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        .calendar-day {
            transition: all 0.2s ease;
        }

        .calendar-day:hover:not(.disabled) {
            transform: scale(1.05);
        }

        .available {
            background: #22c55e;
            color: white;
            cursor: pointer;
        }

        .unavailable {
            background: #ef4444;
            color: white;
            cursor: not-allowed;
        }

        .selected {
            background: #3b82f6;
            color: white;
        }

        .in-range {
            background: #93c5fd;
            color: #1e3a8a;
        }

        .date-picker-day {
            cursor: pointer;
        }

        .date-picker-day:hover {
            transform: scale(1.05);
        }

        .date-selected {
            background: #3b82f6;
            color: white;
            font-weight: bold;
        }

        .toast {
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .modal-overlay {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            ring: 2px;
            ring-color: #3b82f6;
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
</head>

<body class="h-full bg-gradient-to-br from-emerald-50 via-white to-blue-50">
    <div id="app" class="h-full overflow-auto"><!-- Loading State -->
        <div id="loading" class="flex items-center justify-center h-full">
            <div class="text-center">
                <div
                    class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
                </div>
                <p class="text-gray-600">Memuatkan sistem...</p>
            </div>
        </div><!-- Main Content -->
        <div id="main-content" class="hidden"><!-- Header -->
            <header class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white shadow-lg">
                <div class="max-w-7xl mx-auto px-4 py-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center"><span
                                    class="text-2xl">üè°</span>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold">JF Wadi Group</h1>
                                <p class="text-emerald-100 text-sm">Sistem Tempahan Penginapan</p>
                            </div>
                        </div>
                        <div class="flex gap-2"><button id="btn-booking-panel" onclick="showPanel('booking')"
                                class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-medium hover:bg-emerald-50 transition">
                                üìã Tempahan </button> <button id="btn-admin-panel" onclick="showPanel('admin-login')"
                                class="px-4 py-2 bg-emerald-800 text-white rounded-lg font-medium hover:bg-emerald-900 transition">
                                üîê Admin </button>
                        </div>
                    </div>
                </div>
            </header><!-- Booking Panel -->
            <div id="booking-panel" class="max-w-4xl mx-auto px-4 py-6">
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><span>üìÖ</span> Buat
                        Tempahan Baru</h2><!-- Unit Selection -->
                    <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Unit
                            Penginapan</label> <select id="unit-select" onchange="onUnitChange()"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 transition">
                            <option value="">-- Pilih Unit --</option>
                        </select>
                    </div><!-- Calendar -->
                    <div id="calendar-section" class="hidden">
                        <div class="mb-4 flex justify-between items-center"><button onclick="changeMonth(-1)"
                                class="p-2 hover:bg-gray-100 rounded-lg transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7" />
                                </svg></button>
                            <h3 id="calendar-month" class="text-lg font-semibold text-gray-800"></h3><button
                                onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7" />
                                </svg></button>
                        </div><!-- Legend -->
                        <div class="flex gap-4 mb-4 text-sm justify-center flex-wrap">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-500"></div><span>Tersedia</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-red-500"></div><span>Tidak Tersedia</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-blue-500"></div><span>Pilihan Anda</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center font-medium text-gray-600 py-2">
                                Ahd
                            </div>
                            <div class="text-center font-medium text-gray-600 py-2">
                                Isn
                            </div>
                            <div class="text-center font-medium text-gray-600 py-2">
                                Sel
                            </div>
                            <div class="text-center font-medium text-gray-600 py-2">
                                Rab
                            </div>
                            <div class="text-center font-medium text-gray-600 py-2">
                                Kha
                            </div>
                            <div class="text-center font-medium text-gray-600 py-2">
                                Jum
                            </div>
                            <div class="text-center font-medium text-gray-600 py-2">
                                Sab
                            </div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    </div><!-- Date Summary -->
                    <div id="date-summary" class="hidden mt-6 p-4 bg-emerald-50 rounded-xl">
                        <h4 class="font-semibold text-emerald-800 mb-3">üìÜ Ringkasan Tarikh</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-gray-600">Daftar Masuk:</span>
                                <p id="check-in-date" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div><span class="text-gray-600">Daftar Keluar:</span>
                                <p id="check-out-date" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div class="col-span-2"><span class="text-gray-600">Tempoh Menginap:</span>
                                <p id="stay-duration" class="font-semibold text-emerald-600">-</p>
                            </div>
                        </div>
                    </div>
                </div><!-- Booking Summary -->
                <div id="booking-summary" class="hidden bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üí∞ Ringkasan Tempahan</h3>
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between"><span class="text-gray-600">Unit:</span> <span
                                id="summary-unit" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600">Tarikh:</span> <span
                                id="summary-dates" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600">Tempoh:</span> <span
                                id="summary-duration" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600">Harga per Malam:</span> <span
                                id="summary-price-night" class="font-medium">-</span>
                        </div>
                        <hr>
                        <div class="flex justify-between text-lg"><span class="text-gray-600">Jumlah:</span> <span
                                id="summary-total" class="font-bold text-emerald-600">-</span>
                        </div>
                    </div><!-- Promo Code -->
                    <div class="flex gap-2 mb-4"><input type="text" id="promo-code" placeholder="Kod Promo"
                            class="flex-1 p-3 border-2 border-gray-200 rounded-xl"> <button onclick="applyPromo()"
                            class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition">Guna</button>
                    </div>
                    <div id="promo-result" class="hidden text-sm mb-4"></div>
                    <div id="final-price" class="hidden p-4 bg-emerald-100 rounded-xl">
                        <div class="flex justify-between text-xl font-bold text-emerald-700"><span>Harga Akhir:</span>
                            <span id="final-price-amount">-</span>
                        </div>
                    </div>
                </div><!-- Guest Information Form -->
                <div id="guest-form" class="hidden bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">üë§ Maklumat Tetamu</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Penuh <span
                                    class="text-red-500">*</span></label> <input type="text" id="guest-name"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">No. Telefon (WhatsApp) <span
                                    class="text-red-500">*</span></label> <input type="tel" id="guest-phone"
                                placeholder="60123456789"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Pekerjaan <span
                                    class="text-red-500">*</span></label> <input type="text" id="guest-occupation"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Organisasi <span
                                    class="text-red-500">*</span></label> <input type="text" id="guest-organization"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Umur <span
                                    class="text-red-500">*</span></label> <input type="number" id="guest-age" min="18"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Dewasa <span
                                        class="text-red-500">*</span></label> <input type="number" id="guest-adults"
                                    min="1" value="1" onchange="updateTotalGuests()"
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                    required>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Kanak-kanak</label> <input
                                    type="number" id="guest-children" min="0" value="0" onchange="updateTotalGuests()"
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Tetamu</label> <input
                                type="text" id="guest-total" readonly
                                class="w-full p-3 border-2 border-gray-200 rounded-xl bg-gray-50">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Bilangan Kenderaan <span
                                    class="text-red-500">*</span></label> <input type="number" id="guest-vehicles"
                                min="1" max="5" value="1" onchange="updateVehiclePlates()"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div id="vehicle-plates-container" class="md:col-span-2">
                            <div class="mb-2"><label class="block text-sm font-medium text-gray-700 mb-1">Plat Kenderaan
                                    1 <span class="text-red-500">*</span></label> <input type="text" id="guest-plate1"
                                    placeholder="ABC1234"
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                    required>
                            </div>
                        </div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Alamat
                                Tetap <span class="text-red-500">*</span></label> <textarea id="guest-address" rows="2"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required></textarea>
                        </div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Tujuan
                                Menginap <span class="text-red-500">*</span></label> <input type="text"
                                id="guest-purpose" placeholder="Cth: Percutian keluarga, Majlis perkahwinan"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                required>
                        </div>
                        <div class="md:col-span-2"><label
                                class="block text-sm font-medium text-gray-700 mb-1">Mengetahui Kami Daripada?</label>
                            <select id="guest-referral"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
                                <option value="">-- Pilih --</option>
                                <option value="TikTok">TikTok</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Google">Google</option>
                                <option value="Kawan/Keluarga">Kawan/Keluarga</option>
                                <option value="Lain-lain">Lain-lain</option>
                            </select>
                        </div>
                    </div>
                    <div id="capacity-warning" class="hidden mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-xl">
                        <div class="flex items-start gap-3"><span class="text-2xl">‚ö†Ô∏è</span>
                            <div>
                                <p class="font-bold text-red-800">Melebihi Had Kapasiti Unit</p>
                                <p class="text-sm text-red-700 mt-1">Jumlah tetamu melebihi kapasiti unit ini. Sila
                                    kurangkan bilangan tetamu atau pilih unit lain yang lebih besar.</p>
                            </div>
                        </div>
                    </div><button onclick="submitBooking()"
                        class="w-full mt-6 py-4 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-bold rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition transform hover:scale-[1.02]">
                        üì§ Hantar Tempahan </button>
                </div>
            </div><!-- Admin Login Panel -->
            <div id="admin-login-panel" class="hidden max-w-md mx-auto px-4 py-12">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <div
                            class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl">üîê</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Log Masuk Admin</h2>
                        <p class="text-gray-600 mt-2">Sila masukkan maklumat anda</p>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">ID Admin</label> <input
                                type="text" id="admin-login-id"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                placeholder="Masukkan ID Admin">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Kata Laluan</label> <input
                                type="password" id="admin-login-password"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500"
                                placeholder="Masukkan kata laluan">
                        </div>
                        <div id="login-error" class="hidden text-red-600 text-sm p-3 bg-red-50 rounded-xl"></div><button
                            onclick="adminLogin()"
                            class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition">
                            Log Masuk </button>
                    </div>
                </div>
            </div><!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden">
                <div class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 id="admin-welcome" class="text-xl font-bold text-gray-800">Selamat Datang</h2>
                                <p class="text-gray-600 text-sm" id="admin-role-display"></p>
                            </div>
                            <div class="flex gap-2"><button onclick="showProfileSettings()"
                                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                                    ‚öôÔ∏è Tetapan </button> <button onclick="adminLogout()"
                                    class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition"> üö™
                                    Keluar </button>
                            </div>
                        </div>
                    </div>
                </div><!-- Admin Tabs -->
                <div class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto px-4">
                        <div class="flex gap-4 overflow-x-auto"><button onclick="showAdminTab('dashboard')"
                                class="admin-tab px-4 py-3 font-medium text-gray-600 hover:text-emerald-600 whitespace-nowrap tab-active"
                                data-tab="dashboard"> üìä Dashboard </button> <button onclick="showAdminTab('bookings')"
                                class="admin-tab px-4 py-3 font-medium text-gray-600 hover:text-emerald-600 whitespace-nowrap"
                                data-tab="bookings"> üìã Senarai Tempahan </button> <button
                                onclick="showAdminTab('units')"
                                class="admin-tab px-4 py-3 font-medium text-gray-600 hover:text-emerald-600 whitespace-nowrap superadmin-only hidden"
                                data-tab="units"> üè† Urus Unit </button> <button onclick="showAdminTab('admins')"
                                class="admin-tab px-4 py-3 font-medium text-gray-600 hover:text-emerald-600 whitespace-nowrap superadmin-only hidden"
                                data-tab="admins"> üë• Urus Admin </button> <button onclick="showAdminTab('promos')"
                                class="admin-tab px-4 py-3 font-medium text-gray-600 hover:text-emerald-600 whitespace-nowrap superadmin-only hidden"
                                data-tab="promos"> üéüÔ∏è Kod Promo </button> <button onclick="showAdminTab('settings')"
                                class="admin-tab px-4 py-3 font-medium text-gray-600 hover:text-emerald-600 whitespace-nowrap superadmin-only hidden"
                                data-tab="settings"> ‚öôÔ∏è Tetapan </button>
                        </div>
                    </div>
                </div><!-- Dashboard Tab -->
                <div id="tab-dashboard" class="admin-tab-content max-w-7xl mx-auto px-4 py-6">
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100">Tempahan Baru</p>
                                    <p id="stat-new-bookings" class="text-3xl font-bold">0</p>
                                </div><span class="text-4xl">üì¨</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <p class="text-emerald-100 text-sm">Hasil Bulan</p>
                                    <p id="stat-revenue" class="text-3xl font-bold">RM 0</p>
                                </div><span class="text-4xl">üí∞</span>
                            </div>
                            <div class="flex gap-2"><select id="revenue-month" onchange="updateRevenueStats()"
                                    class="flex-1 p-2 text-sm rounded-lg text-gray-800 bg-white bg-opacity-90 border-0">
                                    <option value="0">Januari</option>
                                    <option value="1">Februari</option>
                                    <option value="2">Mac</option>
                                    <option value="3">April</option>
                                    <option value="4">Mei</option>
                                    <option value="5">Jun</option>
                                    <option value="6">Julai</option>
                                    <option value="7">Ogos</option>
                                    <option value="8">September</option>
                                    <option value="9">Oktober</option>
                                    <option value="10">November</option>
                                    <option value="11">Disember</option>
                                </select> <select id="revenue-year" onchange="updateRevenueStats()"
                                    class="p-2 text-sm rounded-lg text-gray-800 bg-white bg-opacity-90 border-0">
                                </select>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100">Jumlah Tempahan</p>
                                    <p id="stat-total-bookings" class="text-3xl font-bold">0</p>
                                </div><span class="text-4xl">üìä</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mb-6"><!-- Date Picker Calendar -->
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">üìÖ Semak Ketersediaan Mengikut Tarikh</h3>
                            <div id="date-picker-calendar-container">
                                <div class="flex justify-between items-center mb-4"><button
                                        onclick="changeDatePickerMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 19l-7-7 7-7" />
                                        </svg></button> <span id="date-picker-month" class="font-semibold"></span>
                                    <button onclick="changeDatePickerMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg></button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-xs mb-2">
                                    <div class="text-center font-medium text-gray-500">
                                        A
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        I
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        S
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        R
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        K
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        J
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        S
                                    </div>
                                </div>
                                <div id="date-picker-grid" class="grid grid-cols-7 gap-1"></div>
                            </div><!-- Available Units Display -->
                            <div id="available-units-display" class="hidden mt-4 p-4 bg-emerald-50 rounded-xl">
                                <h4 class="font-semibold text-emerald-800 mb-3">‚úÖ Unit Tersedia</h4>
                                <p id="selected-date-display" class="text-sm text-gray-600 mb-3"></p>
                                <div id="available-units-list" class="space-y-2 max-h-[180px] overflow-y-auto"></div>
                            </div>
                            <div id="no-units-message" class="hidden mt-4 p-4 bg-red-50 rounded-xl">
                                <p class="text-sm text-red-700">‚ùå Semua unit telah ditempah pada tarikh ini</p>
                            </div>
                        </div><!-- Availability Calendar by Unit -->
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">üè† Jadual Ketersediaan Mengikut Unit</h3>
                            <select id="admin-unit-select" onchange="renderAdminCalendar()"
                                class="w-full p-3 border-2 border-gray-200 rounded-xl mb-4">
                                <option value="">-- Pilih Unit --</option>
                            </select>
                            <div id="admin-calendar-container">
                                <div class="flex justify-between items-center mb-4"><button
                                        onclick="changeAdminMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 19l-7-7 7-7" />
                                        </svg></button> <span id="admin-calendar-month" class="font-semibold"></span>
                                    <button onclick="changeAdminMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg></button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-xs mb-2">
                                    <div class="text-center font-medium text-gray-500">
                                        A
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        I
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        S
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        R
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        K
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        J
                                    </div>
                                    <div class="text-center font-medium text-gray-500">
                                        S
                                    </div>
                                </div>
                                <div id="admin-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-1 gap-6"><!-- Unit Stats -->
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">üìà Statistik Unit Terlaris</h3>
                            <div id="unit-stats-chart" class="flex items-center justify-center min-h-[250px]">
                                <div class="text-center text-gray-500">
                                    <p>Tiada data statistik</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- Bookings Tab -->
                <div id="tab-bookings" class="admin-tab-content hidden max-w-7xl mx-auto px-4 py-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">üìã Senarai Tempahan</h3>
                            <div class="flex gap-2"><select id="filter-status" onchange="filterBookings()"
                                    class="p-2 border rounded-lg">
                                    <option value="">Semua Status</option>
                                    <option value="Belum Disahkan">Belum Disahkan</option>
                                    <option value="Disahkan">Disahkan</option>
                                    <option value="Ditolak">Ditolak</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">ID</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Status</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Nama</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Unit</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Tarikh</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Harga</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Bayaran</th>
                                        <th class="px-4 py-3 text-left font-medium text-gray-600">Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody id="bookings-table-body" class="divide-y">
                                </tbody>
                            </table>
                        </div>
                        <div id="no-bookings" class="hidden text-center py-12 text-gray-500"><span
                                class="text-4xl">üì≠</span>
                            <p class="mt-2">Tiada tempahan</p>
                        </div>
                    </div>
                </div><!-- Units Tab (SuperAdmin Only) -->
                <div id="tab-units" class="admin-tab-content hidden max-w-7xl mx-auto px-4 py-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">üè† Urus Unit Penginapan</h3><button
                                onclick="showAddUnitModal()"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                + Tambah Unit </button>
                        </div>
                        <div id="units-list" class="space-y-4"></div>
                        <div id="no-units" class="hidden text-center py-12 text-gray-500"><span
                                class="text-4xl">üè†</span>
                            <p class="mt-2">Tiada unit. Sila tambah unit baru.</p>
                        </div>
                    </div>
                </div><!-- Admins Tab (SuperAdmin Only) -->
                <div id="tab-admins" class="admin-tab-content hidden max-w-7xl mx-auto px-4 py-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">üë• Urus Admin</h3><button
                                onclick="showAddAdminModal()"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                + Tambah Admin </button>
                        </div>
                        <div id="admins-list" class="space-y-4"></div>
                    </div>
                </div><!-- Promos Tab (SuperAdmin Only) -->
                <div id="tab-promos" class="admin-tab-content hidden max-w-7xl mx-auto px-4 py-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">üéüÔ∏è Kod Promo</h3><button
                                onclick="showAddPromoModal()"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                + Tambah Promo </button>
                        </div>
                        <div id="promos-list" class="space-y-4"></div>
                        <div id="no-promos" class="hidden text-center py-12 text-gray-500"><span
                                class="text-4xl">üéüÔ∏è</span>
                            <p class="mt-2">Tiada kod promo</p>
                        </div>
                    </div>
                </div><!-- Settings Tab (SuperAdmin Only) -->
                <div id="tab-settings" class="admin-tab-content hidden max-w-7xl mx-auto px-4 py-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">‚öôÔ∏è Tetapan Sistem</h3>
                        <div class="space-y-4 max-w-md">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">No. WhatsApp Admin</label>
                                <input type="tel" id="admin-whatsapp-number" placeholder="601111016936"
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
                                <p class="text-xs text-gray-500 mt-1">Maklumat tempahan akan dihantar ke nombor WhatsApp
                                    ini</p>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">ID Group Telegram</label>
                                <input type="text" id="telegram-group-id" placeholder="-1001234567890"
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
                                <p class="text-xs text-gray-500 mt-1">Notifikasi tempahan akan dihantar ke group
                                    Telegram ini</p>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Bot Token Telegram</label>
                                <input type="text" id="telegram-bot-token"
                                    placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
                                <p class="text-xs text-gray-500 mt-1">Token bot Telegram untuk menghantar notifikasi</p>
                            </div><button onclick="saveSystemSettings()"
                                class="px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition">
                                üíæ Simpan Tetapan </button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- Modals Container -->
        <div id="modals-container"></div><!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    </div>
    <script>
        // ==================== GOOGLE SHEETS INTEGRATION ====================
        // üîß TUKAR URL INI DENGAN WEB APP URL ANDA DARI APPS SCRIPT
        // Contoh: 'https://script.google.com/macros/s/AKfycbxxx...xxx/exec'
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxJKBI-X8px7Y3qz-nQ11BbhZXhbmPUS-N9oAHCVcbsswPlZP22kXKk8U2RTCoD17ca_w/exec';

        // ==================== DATA STORAGE ====================
        let allData = [];
        let units = [];
        let bookings = [];
        let admins = [];
        let promos = [];
        let systemSettings = {};

        let currentAdmin = null;
        let selectedUnit = null;
        let selectedCheckIn = null;
        let selectedCheckOut = null;
        let currentMonth = new Date();
        let adminCurrentMonth = new Date();
        let datePickerMonth = new Date();
        let selectedDate = null;
        let calculatedPrice = 0;
        let appliedDiscount = 0;
        let isLoading = false;

        // ==================== HELPER FUNCTIONS ====================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function processData() {
            units = allData.filter(d => d.type === 'unit');
            bookings = allData.filter(d => d.type === 'booking');
            admins = allData.filter(d => d.type === 'admin');
            promos = allData.filter(d => d.type === 'promo');
            const settings = allData.find(d => d.type === 'settings');
            if (settings) {
                systemSettings = settings;
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('jfwadi_data', JSON.stringify(allData));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('jfwadi_data');
                if (stored) {
                    allData = JSON.parse(stored);
                } else {
                    allData = [];
                }
                processData();
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                allData = [];
            }
        }

        // ==================== GOOGLE SHEETS FUNCTIONS (POST & GET dengan CORS) ====================

        /**
         * Fetch data dari Google Sheets menggunakan method GET
         * Endpoint: ?action=getData
         */
        async function fetchDataFromSheets() {
            if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('MASUKKAN_WEB_APP_URL')) {
                console.log('‚ö†Ô∏è Google Sheets URL tidak dikonfigurasi');
                return false;
            }

            try {
                // Method GET dengan parameter action
                const response = await fetch(`${GOOGLE_SHEETS_URL}?action=getData`, {
                    method: 'GET',
                    redirect: 'follow'
                });

                const result = await response.json();

                if (result.success && result.data) {
                    allData = result.data;
                    processData();
                    saveToLocalStorage();
                    console.log('‚úÖ Data berjaya diambil dari Google Sheets (GET)');
                    return true;
                } else {
                    console.error('‚ùå Ralat dari Google Sheets:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Ralat fetch data:', error);
                return false;
            }
        }

        /**
         * Hantar data tempahan ke Google Sheets menggunakan method POST
         * CORS-enabled untuk cross-origin requests
         */
        async function sendToGoogleSheets(bookingData) {
            if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('MASUKKAN_WEB_APP_URL')) {
                console.log('‚ö†Ô∏è Google Sheets URL tidak dikonfigurasi. Data hanya disimpan di localStorage.');
                return { success: true, message: 'Data disimpan di localStorage' };
            }

            try {
                const sheetData = {
                    action: 'addBooking',
                    type: 'booking',
                    __backendId: bookingData.__backendId,
                    timestamp: new Date().toLocaleString('ms-MY', {
                        timeZone: 'Asia/Kuala_Lumpur',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }),
                    created_at: bookingData.created_at,
                    booking_id: bookingData.booking_id,
                    guest_name: bookingData.guest_name,
                    phone: bookingData.phone,
                    occupation: bookingData.occupation,
                    organization: bookingData.organization,
                    age: bookingData.age,
                    adults: bookingData.adults,
                    children: bookingData.children,
                    total_guests: bookingData.total_guests,
                    vehicles: bookingData.vehicles,
                    vehicle_plates: bookingData.vehicle_plates,
                    address: bookingData.address,
                    purpose: bookingData.purpose,
                    referral: bookingData.referral || '-',
                    unit_id: bookingData.unit_id,
                    unit_name: bookingData.unit_name,
                    check_in: bookingData.check_in,
                    check_out: bookingData.check_out,
                    nights: bookingData.nights,
                    days: bookingData.days,
                    promo_code: bookingData.promo_code || '-',
                    total_price: bookingData.total_price,
                    discount: bookingData.discount,
                    final_price: bookingData.final_price,
                    status: bookingData.status,
                    deposit: bookingData.deposit,
                    refund: bookingData.refund
                };

                // Method POST dengan JSON body dan CORS support
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(sheetData),
                    redirect: 'follow'
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ Data berjaya dihantar ke Google Sheets (POST)');
                    return { success: true, message: 'Data berjaya dihantar ke Google Sheets' };
                } else {
                    console.error('‚ùå Ralat dari Google Sheets:', result.error);
                    return { success: false, message: result.error || 'Ralat menghantar data' };
                }

            } catch (error) {
                console.error('‚ùå Ralat menghantar ke Google Sheets:', error);
                return { success: false, message: 'Ralat: ' + error.message };
            }
        }

        /**
         * Sync semua data ke Google Sheets (untuk operasi bulk update)
         * Method POST dengan action=syncData
         */
        async function syncDataToSheets() {
            if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('MASUKKAN_WEB_APP_URL')) {
                console.log('‚ö†Ô∏è Google Sheets URL tidak dikonfigurasi');
                return { success: false, message: 'URL tidak dikonfigurasi' };
            }

            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'syncData',
                        data: allData
                    }),
                    redirect: 'follow'
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ Data berjaya disync ke Google Sheets');
                    return { success: true, message: 'Sync berjaya' };
                } else {
                    console.error('‚ùå Ralat sync:', result.error);
                    return { success: false, message: result.error };
                }

            } catch (error) {
                console.error('‚ùå Ralat sync data:', error);
                return { success: false, message: 'Ralat: ' + error.message };
            }
        }

        // ==================== LOCAL CRUD OPERATIONS ====================
        async function createRecord(record) {
            const newRecord = {
                ...record,
                __backendId: generateId()
            };
            allData.push(newRecord);
            processData();
            saveToLocalStorage();

            // Sync to Google Sheets if it's a booking
            if (record.type === 'booking') {
                await sendToGoogleSheets(newRecord);
            } else {
                // For other records, sync all data
                await syncDataToSheets();
            }

            renderCurrentView();
            return { isOk: true, data: newRecord };
        }

        async function updateRecord(record) {
            const index = allData.findIndex(r => r.__backendId === record.__backendId);
            if (index !== -1) {
                allData[index] = record;
                processData();
                saveToLocalStorage();

                // Sync updated data to Google Sheets
                await syncDataToSheets();

                renderCurrentView();
                return { isOk: true };
            }
            return { isOk: false, error: 'Record not found' };
        }

        async function deleteRecord(record) {
            const index = allData.findIndex(r => r.__backendId === record.__backendId);
            if (index !== -1) {
                allData.splice(index, 1);
                processData();
                saveToLocalStorage();

                // Sync updated data to Google Sheets
                await syncDataToSheets();

                renderCurrentView();
                return { isOk: true };
            }
            return { isOk: false, error: 'Record not found' };
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            try {
                // Try to fetch data from Google Sheets first using GET
                const sheetsLoaded = await fetchDataFromSheets();

                // If Google Sheets fails, fallback to localStorage
                if (!sheetsLoaded) {
                    console.log('üíæ Menggunakan localStorage sebagai fallback');
                    loadFromLocalStorage();
                }

                // Initialize default admin if none exists
                if (admins.length === 0) {
                    await createRecord({
                        type: 'admin',
                        admin_id: 'SuperAdmin',
                        admin_password: 'Admin123',
                        admin_role: 'superadmin',
                        created_at: new Date().toISOString()
                    });
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                renderUnitSelect();
            } catch (error) {
                console.error('Ralat sistem:', error);
                showToast('Ralat sistem', 'error');
            }
        }

        // Start app
        initializeApp();

        // ==================== PANEL NAVIGATION ====================
        function showPanel(panel) {
            document.getElementById('booking-panel').classList.add('hidden');
            document.getElementById('admin-login-panel').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');

            if (panel === 'booking') {
                document.getElementById('booking-panel').classList.remove('hidden');
                renderUnitSelect();
            } else if (panel === 'admin-login') {
                document.getElementById('admin-login-panel').classList.remove('hidden');
            } else if (panel === 'admin-dashboard') {
                document.getElementById('admin-dashboard').classList.remove('hidden');
                renderAdminDashboard();
            }
        }

        // ==================== BOOKING FUNCTIONS ====================
        function renderUnitSelect() {
            const select = document.getElementById('unit-select');
            select.innerHTML = '<option value="">-- Pilih Unit --</option>';
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.__backendId;
                option.textContent = `${unit.unit_name} (Kapasiti: ${unit.unit_capacity} orang)`;
                select.appendChild(option);
            });
        }

        function onUnitChange() {
            const unitId = document.getElementById('unit-select').value;
            if (unitId) {
                selectedUnit = units.find(u => u.__backendId === unitId);
                selectedCheckIn = null;
                selectedCheckOut = null;
                document.getElementById('calendar-section').classList.remove('hidden');
                renderCalendar();
                updateDateSummary();
            } else {
                selectedUnit = null;
                document.getElementById('calendar-section').classList.add('hidden');
                document.getElementById('date-summary').classList.add('hidden');
                document.getElementById('booking-summary').classList.add('hidden');
                document.getElementById('guest-form').classList.add('hidden');
            }
        }

        function getBlockedDatesForUnit(unitId) {
            const unitBookings = bookings.filter(b =>
                b.unit_id === unitId &&
                (b.status === 'Disahkan' || b.status === 'Belum Disahkan')
            );

            const blocked = new Set();
            unitBookings.forEach(booking => {
                const checkIn = new Date(booking.check_in);
                const checkOut = new Date(booking.check_out);
                let current = new Date(checkIn);
                while (current < checkOut) {
                    blocked.add(formatDateKey(current));
                    current.setDate(current.getDate() + 1);
                }
            });

            return blocked;
        }

        function formatDateKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDisplayDate(dateStr) {
            const d = new Date(dateStr);
            return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month');

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const months = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            monthLabel.textContent = `${months[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();

            const blocked = selectedUnit ? getBlockedDatesForUnit(selectedUnit.__backendId) : new Set();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            grid.innerHTML = '';

            // Padding days
            for (let i = 0; i < startPadding; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-2';
                grid.appendChild(emptyDiv);
            }

            // Calendar days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateKey = formatDateKey(date);
                const isPast = date < today;
                const isBlocked = blocked.has(dateKey);
                const isAvailable = !isPast && !isBlocked;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day p-2 text-center rounded-lg text-sm font-medium';
                dayDiv.textContent = day;

                const isSelectedCheckIn = selectedCheckIn && formatDateKey(selectedCheckIn) === dateKey;
                const isSelectedCheckOut = selectedCheckOut && formatDateKey(selectedCheckOut) === dateKey;
                const isInRange = selectedCheckIn && selectedCheckOut && date > selectedCheckIn && date < selectedCheckOut;

                if (isSelectedCheckIn || isSelectedCheckOut) {
                    dayDiv.classList.add('selected');
                } else if (isInRange) {
                    dayDiv.classList.add('in-range');
                } else if (isPast) {
                    dayDiv.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                } else if (isBlocked) {
                    dayDiv.classList.add('unavailable');
                } else {
                    dayDiv.classList.add('available');
                }

                if (isAvailable || isSelectedCheckIn || isSelectedCheckOut) {
                    dayDiv.onclick = () => selectDate(date);
                }

                grid.appendChild(dayDiv);
            }
        }

        function selectDate(date) {
            if (!selectedCheckIn || (selectedCheckIn && selectedCheckOut)) {
                selectedCheckIn = date;
                selectedCheckOut = null;
            } else if (date > selectedCheckIn) {
                const blocked = getBlockedDatesForUnit(selectedUnit.__backendId);
                let hasBlockedInBetween = false;
                let checkDate = new Date(selectedCheckIn);
                checkDate.setDate(checkDate.getDate() + 1);

                while (checkDate < date) {
                    if (blocked.has(formatDateKey(checkDate))) {
                        hasBlockedInBetween = true;
                        break;
                    }
                    checkDate.setDate(checkDate.getDate() + 1);
                }

                if (hasBlockedInBetween) {
                    showToast('Tidak boleh memilih julat tarikh yang mengandungi tarikh tidak tersedia', 'error');
                    return;
                }

                selectedCheckOut = date;
            } else {
                selectedCheckIn = date;
                selectedCheckOut = null;
            }

            renderCalendar();
            updateDateSummary();
        }

        function updateDateSummary() {
            const summaryDiv = document.getElementById('date-summary');
            const bookingSummary = document.getElementById('booking-summary');
            const guestForm = document.getElementById('guest-form');

            if (selectedCheckIn && selectedCheckOut) {
                const nights = Math.ceil((selectedCheckOut - selectedCheckIn) / (1000 * 60 * 60 * 24));
                const days = nights + 1;

                document.getElementById('check-in-date').textContent = formatDisplayDate(selectedCheckIn);
                document.getElementById('check-out-date').textContent = formatDisplayDate(selectedCheckOut);
                document.getElementById('stay-duration').textContent = `${days} hari ${nights} malam`;

                summaryDiv.classList.remove('hidden');

                calculatePrice(nights);

                bookingSummary.classList.remove('hidden');
                guestForm.classList.remove('hidden');
            } else if (selectedCheckIn) {
                document.getElementById('check-in-date').textContent = formatDisplayDate(selectedCheckIn);
                document.getElementById('check-out-date').textContent = 'Pilih tarikh keluar';
                document.getElementById('stay-duration').textContent = '-';
                summaryDiv.classList.remove('hidden');
                bookingSummary.classList.add('hidden');
                guestForm.classList.add('hidden');
            } else {
                summaryDiv.classList.add('hidden');
                bookingSummary.classList.add('hidden');
                guestForm.classList.add('hidden');
            }
        }

        function calculatePrice(nights) {
            if (!selectedUnit) return;

            let totalPrice = 0;
            let currentDate = new Date(selectedCheckIn);

            const specialDates = selectedUnit.special_dates ? JSON.parse(selectedUnit.special_dates) : {};

            for (let i = 0; i < nights; i++) {
                const dateKey = formatDateKey(currentDate);
                let priceForDate = parseFloat(selectedUnit.unit_price || 0);

                if (specialDates[dateKey]) {
                    priceForDate = parseFloat(specialDates[dateKey]);
                }

                totalPrice += priceForDate;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            calculatedPrice = totalPrice;
            appliedDiscount = 0;

            document.getElementById('summary-unit').textContent = selectedUnit.unit_name;
            document.getElementById('summary-dates').textContent = `${formatDisplayDate(selectedCheckIn)} - ${formatDisplayDate(selectedCheckOut)}`;
            document.getElementById('summary-duration').textContent = `${nights + 1} hari ${nights} malam`;
            document.getElementById('summary-price-night').textContent = `RM ${selectedUnit.unit_price}`;
            document.getElementById('summary-total').textContent = `RM ${totalPrice.toFixed(2)}`;

            document.getElementById('final-price').classList.add('hidden');
            document.getElementById('promo-result').classList.add('hidden');
        }

        function applyPromo() {
            const code = document.getElementById('promo-code').value.trim().toUpperCase();
            const promoResult = document.getElementById('promo-result');
            const finalPriceDiv = document.getElementById('final-price');

            if (!code) {
                promoResult.textContent = 'Sila masukkan kod promo';
                promoResult.className = 'text-sm mb-4 text-red-600 bg-red-50 p-3 rounded-xl';
                promoResult.classList.remove('hidden');
                return;
            }

            const promo = promos.find(p => p.promo_code && p.promo_code.toUpperCase() === code && p.promo_active);

            if (promo) {
                appliedDiscount = parseFloat(promo.promo_value || 0);
                const finalPrice = Math.max(0, calculatedPrice - appliedDiscount);

                promoResult.innerHTML = `‚úÖ Kod promo berjaya! Diskaun: <strong>RM ${appliedDiscount.toFixed(2)}</strong>`;
                promoResult.className = 'text-sm mb-4 text-emerald-600 bg-emerald-50 p-3 rounded-xl';
                promoResult.classList.remove('hidden');

                document.getElementById('final-price-amount').textContent = `RM ${finalPrice.toFixed(2)}`;
                finalPriceDiv.classList.remove('hidden');
            } else {
                appliedDiscount = 0;
                promoResult.textContent = '‚ùå Kod promo tidak sah atau telah tamat';
                promoResult.className = 'text-sm mb-4 text-red-600 bg-red-50 p-3 rounded-xl';
                promoResult.classList.remove('hidden');
                finalPriceDiv.classList.add('hidden');
            }
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function updateTotalGuests() {
            const adults = parseInt(document.getElementById('guest-adults').value) || 0;
            const children = parseInt(document.getElementById('guest-children').value) || 0;
            const total = adults + children;
            document.getElementById('guest-total').value = `${total} orang (${adults} dewasa, ${children} kanak-kanak)`;

            const warning = document.getElementById('capacity-warning');
            if (selectedUnit && total > parseInt(selectedUnit.unit_capacity || 0)) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        function updateVehiclePlates() {
            const vehicles = parseInt(document.getElementById('guest-vehicles').value) || 1;
            const container = document.getElementById('vehicle-plates-container');

            let html = '';
            for (let i = 1; i <= vehicles; i++) {
                html += `
          <div class="mb-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Plat Kenderaan ${i} <span class="text-red-500">*</span></label>
            <input type="text" id="guest-plate${i}" placeholder="ABC1234" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500" required>
          </div>
        `;
            }

            container.innerHTML = html;
        }

        function generateBookingId() {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `JFW-${timestamp}-${random}`;
        }

        async function submitBooking() {
            const name = document.getElementById('guest-name').value.trim();
            const phone = document.getElementById('guest-phone').value.trim();
            const occupation = document.getElementById('guest-occupation').value.trim();
            const organization = document.getElementById('guest-organization').value.trim();
            const age = document.getElementById('guest-age').value;
            const adults = document.getElementById('guest-adults').value;
            const children = document.getElementById('guest-children').value || '0';
            const vehicles = document.getElementById('guest-vehicles').value;
            const address = document.getElementById('guest-address').value.trim();
            const purpose = document.getElementById('guest-purpose').value.trim();
            const referral = document.getElementById('guest-referral').value;
            const promoCode = document.getElementById('promo-code').value.trim();

            const totalGuests = parseInt(adults) + parseInt(children);

            if (selectedUnit && totalGuests > parseInt(selectedUnit.unit_capacity || 0)) {
                showToast('‚ùå Jumlah tetamu melebihi had kapasiti unit. Sila kurangkan bilangan tetamu atau pilih unit lain.', 'error');
                document.getElementById('capacity-warning').scrollIntoView({ behavior: 'smooth' });
                return;
            }

            const vehiclePlates = [];
            for (let i = 1; i <= parseInt(vehicles); i++) {
                const plateInput = document.getElementById(`guest-plate${i}`);
                if (!plateInput || !plateInput.value.trim()) {
                    showToast(`Sila masukkan plat kenderaan ${i}`, 'error');
                    return;
                }
                vehiclePlates.push(plateInput.value.trim());
            }

            if (!name || !phone || !occupation || !organization || !age || !adults || !address || !purpose) {
                showToast('Sila lengkapkan semua maklumat wajib', 'error');
                return;
            }

            if (!selectedUnit || !selectedCheckIn || !selectedCheckOut) {
                showToast('Sila pilih unit dan tarikh', 'error');
                return;
            }

            if (bookings.length >= 999) {
                showToast('Had tempahan maksimum telah dicapai', 'error');
                return;
            }

            const nights = Math.ceil((selectedCheckOut - selectedCheckIn) / (1000 * 60 * 60 * 24));
            const days = nights + 1;
            const finalPrice = Math.max(0, calculatedPrice - appliedDiscount);
            const bookingId = generateBookingId();

            const bookingData = {
                type: 'booking',
                booking_id: bookingId,
                guest_name: name,
                phone: phone,
                occupation: occupation,
                organization: organization,
                age: parseInt(age),
                adults: parseInt(adults),
                children: parseInt(children),
                total_guests: totalGuests,
                vehicles: parseInt(vehicles),
                vehicle_plates: vehiclePlates.join(', '),
                address: address,
                purpose: purpose,
                referral: referral,
                unit_id: selectedUnit.__backendId,
                unit_name: selectedUnit.unit_name,
                check_in: selectedCheckIn.toISOString(),
                check_out: selectedCheckOut.toISOString(),
                nights: nights,
                days: days,
                promo_code: promoCode,
                total_price: calculatedPrice,
                discount: appliedDiscount,
                final_price: finalPrice,
                status: 'Belum Disahkan',
                deposit: 0,
                refund: 0,
                created_at: new Date().toISOString()
            };

            setLoading(true);

            const result = await createRecord(bookingData);

            if (result.isOk) {
                await sendTelegramNotification(bookingData);
                showBookingConfirmation(bookingData);
                resetBookingForm();
            } else {
                showToast('Ralat menghantar tempahan', 'error');
            }

            setLoading(false);
        }

        async function sendTelegramNotification(bookingData) {
            try {
                const telegramGroupId = systemSettings.telegram_group_id;
                const telegramBotToken = systemSettings.telegram_bot_token;

                if (!telegramGroupId || !telegramBotToken) {
                    console.log('Telegram settings not configured');
                    return;
                }

                const checkInDate = new Date(bookingData.check_in);
                const checkOutDate = new Date(bookingData.check_out);
                const isFriday = checkOutDate.getDay() === 5;

                const message = `üè° *JF Wadi Group - Tempahan Baru*

üìã *ID Tempahan:* ${bookingData.booking_id}
üë§ *Nama:* ${bookingData.guest_name}
üì± *Telefon:* ${bookingData.phone}
üè¢ *Organisasi:* ${bookingData.organization}
üíº *Pekerjaan:* ${bookingData.occupation}
üéÇ *Umur:* ${bookingData.age} tahun

üè† *Unit:* ${bookingData.unit_name}
üìÖ *Daftar Masuk:* ${formatDisplayDate(checkInDate)}
üìÖ *Daftar Keluar:* ${formatDisplayDate(checkOutDate)}
‚è±Ô∏è *Tempoh:* ${bookingData.days} hari ${bookingData.nights} malam

üë• *Tetamu:* ${bookingData.total_guests} orang (${bookingData.adults} dewasa, ${bookingData.children} kanak-kanak)
üöó *Kenderaan:* ${bookingData.vehicles} (${bookingData.vehicle_plates})
üè° *Alamat:* ${bookingData.address}
üéØ *Tujuan:* ${bookingData.purpose}

üí∞ *Harga:* RM ${bookingData.final_price.toFixed(2)}
${bookingData.promo_code ? `üéüÔ∏è *Kod Promo:* ${bookingData.promo_code} (Diskaun: RM ${bookingData.discount.toFixed(2)})` : ''}

‚è∞ *Panduan:*
‚Ä¢ Daftar Masuk: 3:00 petang
‚Ä¢ Daftar Keluar: ${isFriday ? '11:00 pagi' : '12:00 tengahari'}

‚úÖ Sila sahkan tempahan ini.`;

                const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;

                await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: telegramGroupId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });

                console.log('Notifikasi Telegram dihantar');

            } catch (error) {
                console.error('Ralat menghantar notifikasi Telegram:', error);
            }
        }

        function showBookingConfirmation(booking) {
            const checkInDate = new Date(booking.check_in);
            const checkOutDate = new Date(booking.check_out);
            const isFriday = checkOutDate.getDay() === 5;
            const checkOutTime = isFriday ? '11:00 pagi' : '12:00 tengahari';

            const adminPhone = systemSettings.admin_whatsapp || '601111016936';

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90%] overflow-y-auto">
          <div class="p-6">
            <div class="text-center mb-6">
              <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">‚úÖ</span>
              </div>
              <h3 class="text-xl font-bold text-gray-800">Tempahan Berjaya Dihantar!</h3>
              <p class="text-sm text-gray-600 mt-2">Notifikasi telah dihantar ke admin untuk pengesahan</p>
            </div>

            <div class="bg-gray-50 rounded-xl p-4 mb-4 space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">ID Tempahan:</span>
                <span class="font-bold text-emerald-600">${booking.booking_id}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Nama:</span>
                <span class="font-medium">${booking.guest_name}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Unit:</span>
                <span class="font-medium">${booking.unit_name}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Daftar Masuk:</span>
                <span class="font-medium">${formatDisplayDate(checkInDate)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Daftar Keluar:</span>
                <span class="font-medium">${formatDisplayDate(checkOutDate)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Plat Kenderaan:</span>
                <span class="font-medium">${booking.vehicle_plates}</span>
              </div>
              <hr>
              <div class="flex justify-between text-lg">
                <span class="text-gray-800">Harga:</span>
                <span class="font-bold text-emerald-600">RM ${booking.final_price.toFixed(2)}</span>
              </div>
            </div>

            <div class="bg-blue-50 rounded-xl p-4 mb-6">
              <h4 class="font-semibold text-blue-800 mb-2">üìã Panduan Daftar Masuk & Keluar</h4>
              <ul class="text-sm text-blue-700 space-y-1">
                <li>‚Ä¢ Daftar Masuk: <strong>3:00 petang</strong></li>
                <li>‚Ä¢ Daftar Keluar: <strong>${checkOutTime}</strong></li>
                ${isFriday ? '<li class="text-orange-600">‚ö†Ô∏è Hari Jumaat: Daftar keluar pada 11:00 pagi</li>' : ''}
              </ul>
            </div>

            <div class="flex gap-3">
              <button onclick="sendBookingToAdmin('${adminPhone}', '${booking.booking_id}')" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition">
                üì± WhatsApp Admin
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        function sendBookingToAdmin(adminPhone, bookingId) {
            const booking = bookings.find(b => b.booking_id === bookingId);

            if (!booking) {
                const message = `*JF Wadi Group - Tempahan Baru*\n\nID Tempahan: ${bookingId}\n\nTempahan telah dihantar. Sila tunggu pengesahan daripada pihak kami.\n\nPanduan:\n‚Ä¢ Daftar Masuk: 3:00 petang\n‚Ä¢ Daftar Keluar: 12:00 tengahari (Jumaat: 11:00 pagi)`;
                const url = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank', 'noopener,noreferrer');
                return;
            }

            const checkInDate = new Date(booking.check_in);
            const checkOutDate = new Date(booking.check_out);
            const isFriday = checkOutDate.getDay() === 5;

            const message = `*JF Wadi Group - Tempahan Baru*

ID Tempahan: ${booking.booking_id}
Nama: ${booking.guest_name}
Telefon: ${booking.phone}
Organisasi: ${booking.organization}
Pekerjaan: ${booking.occupation}
Umur: ${booking.age} tahun

Unit: ${booking.unit_name}
Daftar Masuk: ${formatDisplayDate(checkInDate)}
Daftar Keluar: ${formatDisplayDate(checkOutDate)}
Tempoh: ${booking.days} hari ${booking.nights} malam

Tetamu: ${booking.total_guests} orang (${booking.adults} dewasa, ${booking.children} kanak-kanak)
Kenderaan: ${booking.vehicles} (${booking.vehicle_plates})
Alamat: ${booking.address}
Tujuan: ${booking.purpose}

Harga: RM ${booking.final_price.toFixed(2)}
${booking.promo_code ? `Kod Promo: ${booking.promo_code} (Diskaun: RM ${booking.discount.toFixed(2)})` : ''}

*Panduan:*
‚Ä¢ Daftar Masuk: 3:00 petang
‚Ä¢ Daftar Keluar: ${isFriday ? '11:00 pagi' : '12:00 tengahari'}

Sila sahkan tempahan ini.`;

            const url = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        function resetBookingForm() {
            document.getElementById('unit-select').value = '';
            document.getElementById('guest-name').value = '';
            document.getElementById('guest-phone').value = '';
            document.getElementById('guest-occupation').value = '';
            document.getElementById('guest-organization').value = '';
            document.getElementById('guest-age').value = '';
            document.getElementById('guest-adults').value = '1';
            document.getElementById('guest-children').value = '0';
            document.getElementById('guest-vehicles').value = '1';
            document.getElementById('guest-address').value = '';
            document.getElementById('guest-purpose').value = '';
            document.getElementById('guest-referral').value = '';
            document.getElementById('promo-code').value = '';

            const container = document.getElementById('vehicle-plates-container');
            container.innerHTML = `
        <div class="mb-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Plat Kenderaan 1 <span class="text-red-500">*</span></label>
          <input type="text" id="guest-plate1" placeholder="ABC1234" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500" required>
        </div>
      `;

            selectedUnit = null;
            selectedCheckIn = null;
            selectedCheckOut = null;
            calculatedPrice = 0;
            appliedDiscount = 0;

            document.getElementById('calendar-section').classList.add('hidden');
            document.getElementById('date-summary').classList.add('hidden');
            document.getElementById('booking-summary').classList.add('hidden');
            document.getElementById('guest-form').classList.add('hidden');
            document.getElementById('capacity-warning').classList.add('hidden');
        }

        // ==================== ADMIN FUNCTIONS ====================
        function adminLogin() {
            const id = document.getElementById('admin-login-id').value.trim();
            const password = document.getElementById('admin-login-password').value;
            const errorDiv = document.getElementById('login-error');

            const admin = admins.find(a => a.admin_id === id && a.admin_password === password);

            if (admin) {
                currentAdmin = admin;
                errorDiv.classList.add('hidden');
                showPanel('admin-dashboard');
            } else {
                errorDiv.textContent = 'ID Admin atau kata laluan tidak sah';
                errorDiv.classList.remove('hidden');
            }
        }

        function adminLogout() {
            currentAdmin = null;
            document.getElementById('admin-login-id').value = '';
            document.getElementById('admin-login-password').value = '';
            showPanel('admin-login');
        }

        function renderAdminDashboard() {
            if (!currentAdmin) return;

            document.getElementById('admin-welcome').textContent = `Selamat Datang, ${currentAdmin.admin_id}!`;
            document.getElementById('admin-role-display').textContent =
                currentAdmin.admin_role === 'superadmin' ? 'üëë Super Admin' : 'üë§ Admin';

            const superAdminTabs = document.querySelectorAll('.superadmin-only');
            superAdminTabs.forEach(tab => {
                if (currentAdmin.admin_role === 'superadmin') {
                    tab.classList.remove('hidden');
                } else {
                    tab.classList.add('hidden');
                }
            });

            updateDashboardStats();
            renderAdminUnitSelect();
            renderAdminCalendar();
            renderDatePickerCalendar();
            renderUnitStats();
        }

        function updateDashboardStats() {
            const newBookings = bookings.filter(b => b.status === 'Belum Disahkan').length;
            document.getElementById('stat-new-bookings').textContent = newBookings;

            const yearSelect = document.getElementById('revenue-year');
            if (yearSelect.options.length === 0) {
                const currentYear = new Date().getFullYear();
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
            }

            const now = new Date();
            document.getElementById('revenue-month').value = now.getMonth();
            document.getElementById('revenue-year').value = now.getFullYear();

            updateRevenueStats();
            document.getElementById('stat-total-bookings').textContent = bookings.length;
        }

        function updateRevenueStats() {
            const selectedMonth = parseInt(document.getElementById('revenue-month').value);
            const selectedYear = parseInt(document.getElementById('revenue-year').value);

            const monthStart = new Date(selectedYear, selectedMonth, 1);
            const monthEnd = new Date(selectedYear, selectedMonth + 1, 0);

            let revenue = 0;
            bookings.forEach(b => {
                if (b.status === 'Disahkan') {
                    const checkIn = new Date(b.check_in);
                    if (checkIn >= monthStart && checkIn <= monthEnd) {
                        revenue += parseFloat(b.deposit || 0) - parseFloat(b.refund || 0);
                    }
                }
            });
            document.getElementById('stat-revenue').textContent = `RM ${revenue.toFixed(2)}`;
        }

        function renderAdminUnitSelect() {
            const select = document.getElementById('admin-unit-select');
            select.innerHTML = '<option value="">-- Pilih Unit --</option>';
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.__backendId;
                option.textContent = unit.unit_name;
                select.appendChild(option);
            });
        }

        function renderAdminCalendar() {
            const grid = document.getElementById('admin-calendar-grid');
            const monthLabel = document.getElementById('admin-calendar-month');

            const year = adminCurrentMonth.getFullYear();
            const month = adminCurrentMonth.getMonth();

            const months = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            monthLabel.textContent = `${months[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();

            const selectedUnitId = document.getElementById('admin-unit-select').value;
            const blocked = selectedUnitId ? getBlockedDatesForUnit(selectedUnitId) : new Set();

            grid.innerHTML = '';

            for (let i = 0; i < startPadding; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-1';
                grid.appendChild(emptyDiv);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateKey = formatDateKey(date);
                const isBlocked = blocked.has(dateKey);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-1 text-center rounded text-xs font-medium';
                dayDiv.textContent = day;

                if (isBlocked) {
                    dayDiv.classList.add('bg-red-500', 'text-white');
                } else {
                    dayDiv.classList.add('bg-green-500', 'text-white');
                }

                grid.appendChild(dayDiv);
            }
        }

        function changeAdminMonth(delta) {
            adminCurrentMonth.setMonth(adminCurrentMonth.getMonth() + delta);
            renderAdminCalendar();
        }

        function renderDatePickerCalendar() {
            const grid = document.getElementById('date-picker-grid');
            const monthLabel = document.getElementById('date-picker-month');

            const year = datePickerMonth.getFullYear();
            const month = datePickerMonth.getMonth();

            const months = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            monthLabel.textContent = `${months[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            grid.innerHTML = '';

            for (let i = 0; i < startPadding; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-1';
                grid.appendChild(emptyDiv);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateKey = formatDateKey(date);
                const isPast = date < today;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'date-picker-day p-1 text-center rounded text-xs font-medium transition-all';
                dayDiv.textContent = day;

                const isSelected = selectedDate && formatDateKey(selectedDate) === dateKey;

                if (isSelected) {
                    dayDiv.classList.add('date-selected');
                } else if (isPast) {
                    dayDiv.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                } else {
                    dayDiv.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-blue-100');
                }

                if (!isPast) {
                    dayDiv.onclick = () => selectDateForAvailability(date);
                }

                grid.appendChild(dayDiv);
            }
        }

        function selectDateForAvailability(date) {
            selectedDate = date;
            renderDatePickerCalendar();
            displayAvailableUnitsForDate(date);
        }

        function displayAvailableUnitsForDate(date) {
            const dateKey = formatDateKey(date);
            const displayDiv = document.getElementById('available-units-display');
            const noUnitsDiv = document.getElementById('no-units-message');
            const listDiv = document.getElementById('available-units-list');
            const dateDisplay = document.getElementById('selected-date-display');

            dateDisplay.textContent = `Tarikh: ${formatDisplayDate(date)}`;

            displayDiv.classList.remove('hidden');
            noUnitsDiv.classList.add('hidden');

            listDiv.innerHTML = units.map(unit => {
                const blockedDates = getBlockedDatesForUnit(unit.__backendId);
                const isAvailable = !blockedDates.has(dateKey);

                const specialDates = unit.special_dates ? JSON.parse(unit.special_dates) : {};
                const priceForDate = specialDates[dateKey] ? parseFloat(specialDates[dateKey]) : parseFloat(unit.unit_price || 0);

                if (isAvailable) {
                    return `
            <div class="flex items-center justify-between p-3 bg-white rounded-lg border-2 border-emerald-200">
              <div>
                <p class="font-semibold text-gray-800">${unit.unit_name}</p>
                <p class="text-sm text-emerald-600 font-medium">RM ${priceForDate.toFixed(2)}</p>
              </div>
              <span class="inline-block px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full">
                ‚úì Tersedia
              </span>
            </div>
          `;
                } else {
                    return `
            <div class="flex items-center justify-between p-3 bg-white rounded-lg border-2 border-red-200">
              <div>
                <p class="font-semibold text-gray-800">${unit.unit_name}</p>
                <p class="text-sm text-gray-500 font-medium">RM ${priceForDate.toFixed(2)}</p>
              </div>
              <span class="inline-block px-3 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full">
                ‚úó Tidak Tersedia
              </span>
            </div>
          `;
                }
            }).join('');
        }

        function changeDatePickerMonth(delta) {
            datePickerMonth.setMonth(datePickerMonth.getMonth() + delta);
            renderDatePickerCalendar();

            document.getElementById('available-units-display').classList.add('hidden');
            document.getElementById('no-units-message').classList.add('hidden');
            selectedDate = null;
        }

        function renderUnitStats() {
            const statsContainer = document.getElementById('unit-stats-chart');

            if (units.length === 0 || bookings.length === 0) {
                statsContainer.innerHTML = `
          <div class="text-center text-gray-500">
            <p>Tiada data statistik</p>
          </div>
        `;
                return;
            }

            const unitCounts = {};
            units.forEach(u => {
                unitCounts[u.__backendId] = { name: u.unit_name, count: 0 };
            });

            bookings.forEach(b => {
                if (b.status === 'Disahkan' && unitCounts[b.unit_id]) {
                    unitCounts[b.unit_id].count++;
                }
            });

            const total = Object.values(unitCounts).reduce((sum, u) => sum + u.count, 0);

            if (total === 0) {
                statsContainer.innerHTML = `
          <div class="text-center text-gray-500">
            <p>Tiada tempahan disahkan</p>
          </div>
        `;
                return;
            }

            const colors = ['#059669', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            let html = '<div class="flex items-center gap-4"><div class="relative w-32 h-32">';

            let cumulativePercent = 0;
            const unitArray = Object.values(unitCounts).filter(u => u.count > 0);

            html += '<svg viewBox="0 0 32 32" class="w-full h-full transform -rotate-90">';

            unitArray.forEach((unit, i) => {
                const percent = (unit.count / total) * 100;
                const strokeDasharray = `${percent} ${100 - percent}`;
                const strokeDashoffset = -cumulativePercent;

                html += `<circle r="16" cx="16" cy="16" fill="transparent" stroke="${colors[i % colors.length]}" 
          stroke-width="32" stroke-dasharray="${strokeDasharray}" stroke-dashoffset="${strokeDashoffset}" 
          class="transition-all duration-300"/>`;

                cumulativePercent += percent;
            });

            html += '</svg></div><div class="space-y-2">';

            unitArray.forEach((unit, i) => {
                const percent = ((unit.count / total) * 100).toFixed(1);
                html += `
          <div class="flex items-center gap-2 text-sm">
            <div class="w-3 h-3 rounded-full" style="background: ${colors[i % colors.length]}"></div>
            <span>${unit.name}: ${unit.count} (${percent}%)</span>
          </div>
        `;
            });

            html += '</div></div>';
            statsContainer.innerHTML = html;
        }

        function showAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('tab-active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));

            document.querySelector(`.admin-tab[data-tab="${tab}"]`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');

            if (tab === 'bookings') renderBookingsTable();
            if (tab === 'units') renderUnitsList();
            if (tab === 'admins') renderAdminsList();
            if (tab === 'promos') renderPromosList();
            if (tab === 'settings') loadSystemSettings();
        }

        function filterBookings() {
            renderBookingsTable();
        }

        function renderBookingsTable() {
            const tbody = document.getElementById('bookings-table-body');
            const noBookings = document.getElementById('no-bookings');
            const filterStatus = document.getElementById('filter-status').value;

            let filteredBookings = [...bookings];
            if (filterStatus) {
                filteredBookings = filteredBookings.filter(b => b.status === filterStatus);
            }

            filteredBookings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            if (filteredBookings.length === 0) {
                tbody.innerHTML = '';
                noBookings.classList.remove('hidden');
                return;
            }

            noBookings.classList.add('hidden');

            tbody.innerHTML = filteredBookings.map(b => {
                const statusColors = {
                    'Belum Disahkan': 'bg-yellow-100 text-yellow-800',
                    'Disahkan': 'bg-green-100 text-green-800',
                    'Ditolak': 'bg-red-100 text-red-800'
                };

                return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">
              <button onclick="showGuestDetailsModal('${b.__backendId}')" class="font-mono text-xs text-blue-600 hover:text-blue-800 hover:underline font-medium">
                ${b.booking_id}
              </button>
            </td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[b.status] || 'bg-gray-100'}">${b.status}</span>
            </td>
            <td class="px-4 py-3">${b.guest_name}</td>
            <td class="px-4 py-3">${b.unit_name}</td>
            <td class="px-4 py-3 text-xs">
              ${formatDisplayDate(new Date(b.check_in))} - ${formatDisplayDate(new Date(b.check_out))}
            </td>
            <td class="px-4 py-3">RM ${parseFloat(b.final_price).toFixed(2)}</td>
            <td class="px-4 py-3 text-xs">
              <div>Deposit: RM ${parseFloat(b.deposit || 0).toFixed(2)}</div>
              <div>Refund: RM ${parseFloat(b.refund || 0).toFixed(2)}</div>
            </td>
            <td class="px-4 py-3">
              <div class="flex gap-1">
                ${b.status === 'Belum Disahkan' ? `
                  <button onclick="updateBookingStatus('${b.__backendId}', 'Disahkan')" class="p-1 bg-green-100 text-green-600 rounded hover:bg-green-200" title="Sahkan">‚úì</button>
                  <button onclick="updateBookingStatus('${b.__backendId}', 'Ditolak')" class="p-1 bg-red-100 text-red-600 rounded hover:bg-red-200" title="Tolak">‚úó</button>
                ` : ''}
                <button onclick="showPaymentModal('${b.__backendId}')" class="p-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200" title="Bayaran">üí∞</button>
                <button onclick="confirmDeleteBooking('${b.__backendId}')" class="p-1 bg-red-100 text-red-600 rounded hover:bg-red-200" title="Padam">üóë</button>
              </div>
            </td>
          </tr>
        `;
            }).join('');
        }

        async function updateBookingStatus(id, status) {
            const booking = bookings.find(b => b.__backendId === id);
            if (!booking) return;

            setLoading(true);
            const result = await updateRecord({ ...booking, status });
            setLoading(false);

            if (result.isOk) {
                showToast(`Tempahan berjaya ${status === 'Disahkan' ? 'disahkan' : 'ditolak'}`, 'success');
            } else {
                showToast('Ralat mengemaskini tempahan', 'error');
            }
        }

        function showPaymentModal(bookingId) {
            const booking = bookings.find(b => b.__backendId === bookingId);
            if (!booking) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üí∞ Kemaskini Bayaran</h3>
          <div class="space-y-4">
            <div>
              <p class="text-sm text-gray-600">Tempahan: ${booking.booking_id}</p>
              <p class="text-sm text-gray-600">Harga: RM ${parseFloat(booking.final_price).toFixed(2)}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Deposit (RM)</label>
              <input type="number" id="payment-deposit" value="${booking.deposit || 0}" min="0" step="0.01" class="w-full p-3 border-2 border-gray-200 rounded-xl">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Refund (RM)</label>
              <input type="number" id="payment-refund" value="${booking.refund || 0}" min="0" step="0.01" class="w-full p-3 border-2 border-gray-200 rounded-xl">
            </div>
            <div class="flex gap-3">
              <button onclick="savePayment('${bookingId}')" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">
                üíæ Simpan
              </button>
              <button onclick="markPaymentComplete('${bookingId}')" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700">
                ‚úì Selesai
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
                Batal
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function savePayment(bookingId) {
            const booking = bookings.find(b => b.__backendId === bookingId);
            if (!booking) return;

            const deposit = parseFloat(document.getElementById('payment-deposit').value) || 0;
            const refund = parseFloat(document.getElementById('payment-refund').value) || 0;

            setLoading(true);
            const result = await updateRecord({ ...booking, deposit, refund });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Bayaran berjaya dikemaskini', 'success');
            } else {
                showToast('Ralat mengemaskini bayaran', 'error');
            }
        }

        async function markPaymentComplete(bookingId) {
            const booking = bookings.find(b => b.__backendId === bookingId);
            if (!booking) return;

            const deposit = parseFloat(booking.final_price);

            setLoading(true);
            const result = await updateRecord({ ...booking, deposit, refund: 0 });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Bayaran selesai', 'success');
            } else {
                showToast('Ralat mengemaskini bayaran', 'error');
            }
        }

        function confirmDeleteBooking(bookingId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-3xl">‚ö†Ô∏è</span>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">Padam Tempahan?</h3>
          <p class="text-gray-600 mb-6">Tindakan ini tidak boleh dibatalkan.</p>
          <div class="flex gap-3">
            <button onclick="deleteBooking('${bookingId}')" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">
              Padam
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
              Batal
            </button>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function deleteBooking(bookingId) {
            const booking = bookings.find(b => b.__backendId === bookingId);
            if (!booking) return;

            setLoading(true);
            const result = await deleteRecord(booking);
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Tempahan berjaya dipadam', 'success');
            } else {
                showToast('Ralat memadam tempahan', 'error');
            }
        }

        function showGuestDetailsModal(bookingId) {
            const booking = bookings.find(b => b.__backendId === bookingId);
            if (!booking) return;

            const checkInDate = new Date(booking.check_in);
            const checkOutDate = new Date(booking.check_out);
            const isFriday = checkOutDate.getDay() === 5;
            const checkOutTime = isFriday ? '11:00 pagi' : '12:00 tengahari';

            const statusColors = {
                'Belum Disahkan': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                'Disahkan': 'bg-green-100 text-green-700 border-green-300',
                'Ditolak': 'bg-red-100 text-red-700 border-red-300'
            };

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white p-6 rounded-t-2xl">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-2xl font-bold mb-2">üìã Maklumat Lengkap Tempahan</h3>
                <p class="text-emerald-100 text-sm">ID: ${booking.booking_id}</p>
              </div>
              <button onclick="this.closest('.modal-overlay').remove()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <div class="p-6 space-y-6">
            <!-- Status Badge -->
            <div class="flex justify-center">
              <span class="px-6 py-3 rounded-xl text-base font-bold border-2 ${statusColors[booking.status] || 'bg-gray-100 text-gray-700 border-gray-300'}">
                ${booking.status}
              </span>
            </div>

            <!-- Guest Information -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                <span class="text-2xl">üë§</span> Maklumat Tetamu
              </h4>
              <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Nama Penuh:</span>
                  <span class="font-semibold text-gray-800">${booking.guest_name}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">No. Telefon:</span>
                  <span class="font-semibold text-gray-800">${booking.phone}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Umur:</span>
                  <span class="font-semibold text-gray-800">${booking.age} tahun</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Pekerjaan:</span>
                  <span class="font-semibold text-gray-800">${booking.occupation}</span>
                </div>
                <div class="bg-white rounded-lg p-3 md:col-span-2">
                  <span class="text-gray-600 block mb-1">Organisasi:</span>
                  <span class="font-semibold text-gray-800">${booking.organization}</span>
                </div>
                <div class="bg-white rounded-lg p-3 md:col-span-2">
                  <span class="text-gray-600 block mb-1">Alamat:</span>
                  <span class="font-semibold text-gray-800">${booking.address}</span>
                </div>
              </div>
            </div>

            <!-- Booking Details -->
            <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl p-6 border-2 border-emerald-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                <span class="text-2xl">üè†</span> Maklumat Tempahan
              </h4>
              <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Unit:</span>
                  <span class="font-semibold text-gray-800">${booking.unit_name}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Tempoh:</span>
                  <span class="font-semibold text-emerald-700">${booking.days} hari ${booking.nights} malam</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Daftar Masuk:</span>
                  <span class="font-semibold text-gray-800">${formatDisplayDate(checkInDate)} (3:00 petang)</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Daftar Keluar:</span>
                  <span class="font-semibold text-gray-800">${formatDisplayDate(checkOutDate)} (${checkOutTime})</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Jumlah Tetamu:</span>
                  <span class="font-semibold text-gray-800">${booking.total_guests} orang (${booking.adults} dewasa, ${booking.children} kanak-kanak)</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Bilangan Kenderaan:</span>
                  <span class="font-semibold text-gray-800">${booking.vehicles}</span>
                </div>
                <div class="bg-white rounded-lg p-3 md:col-span-2">
                  <span class="text-gray-600 block mb-1">Plat Kenderaan:</span>
                  <span class="font-semibold text-gray-800">${booking.vehicle_plates}</span>
                </div>
                <div class="bg-white rounded-lg p-3 md:col-span-2">
                  <span class="text-gray-600 block mb-1">Tujuan Menginap:</span>
                  <span class="font-semibold text-gray-800">${booking.purpose}</span>
                </div>
                ${booking.referral ? `
                <div class="bg-white rounded-lg p-3 md:col-span-2">
                  <span class="text-gray-600 block mb-1">Mengetahui Daripada:</span>
                  <span class="font-semibold text-gray-800">${booking.referral}</span>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Payment Details -->
            <div class="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-xl p-6 border-2 border-amber-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                <span class="text-2xl">üí∞</span> Maklumat Bayaran
              </h4>
              <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Harga Asal:</span>
                  <span class="font-semibold text-gray-800">RM ${parseFloat(booking.total_price).toFixed(2)}</span>
                </div>
                ${booking.promo_code ? `
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Kod Promo:</span>
                  <span class="font-semibold text-emerald-600">${booking.promo_code}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Diskaun:</span>
                  <span class="font-semibold text-emerald-600">- RM ${parseFloat(booking.discount).toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Jumlah Bayaran:</span>
                  <span class="font-bold text-emerald-700 text-lg">RM ${parseFloat(booking.final_price).toFixed(2)}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Deposit Dibayar:</span>
                  <span class="font-semibold ${parseFloat(booking.deposit) >= parseFloat(booking.final_price) ? 'text-green-600' : 'text-orange-600'}">RM ${parseFloat(booking.deposit || 0).toFixed(2)}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Refund:</span>
                  <span class="font-semibold text-gray-800">RM ${parseFloat(booking.refund || 0).toFixed(2)}</span>
                </div>
                <div class="bg-white rounded-lg p-3">
                  <span class="text-gray-600 block mb-1">Baki:</span>
                  <span class="font-bold ${(parseFloat(booking.final_price) - parseFloat(booking.deposit || 0) + parseFloat(booking.refund || 0)) > 0 ? 'text-red-600' : 'text-green-600'} text-lg">
                    RM ${(parseFloat(booking.final_price) - parseFloat(booking.deposit || 0) + parseFloat(booking.refund || 0)).toFixed(2)}
                  </span>
                </div>
              </div>
            </div>

            <!-- Timestamp -->
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
              <div class="flex items-center justify-between text-xs text-gray-600">
                <span>üìÖ Tarikh Tempahan Dibuat:</span>
                <span class="font-medium">${new Date(booking.created_at).toLocaleString('ms-MY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}</span>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4 border-t-2 border-gray-200">
              ${booking.status === 'Belum Disahkan' ? `
                <button onclick="updateBookingStatus('${booking.__backendId}', 'Disahkan'); this.closest('.modal-overlay').remove();" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition">
                  ‚úÖ Sahkan Tempahan
                </button>
                <button onclick="updateBookingStatus('${booking.__backendId}', 'Ditolak'); this.closest('.modal-overlay').remove();" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 transition">
                  ‚ùå Tolak Tempahan
                </button>
              ` : ''}
              <button onclick="showPaymentModal('${booking.__backendId}'); this.closest('.modal-overlay').remove();" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition">
                üí∞ Kemaskini Bayaran
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        // ==================== UNIT MANAGEMENT ====================
        function renderUnitsList() {
            const container = document.getElementById('units-list');
            const noUnits = document.getElementById('no-units');

            if (units.length === 0) {
                container.innerHTML = '';
                noUnits.classList.remove('hidden');
                return;
            }

            noUnits.classList.add('hidden');

            container.innerHTML = units.map(u => `
        <div class="border rounded-xl p-4 hover:shadow-md transition">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-semibold text-gray-800">${u.unit_name}</h4>
              <p class="text-sm text-gray-600">Kapasiti: ${u.unit_capacity} orang</p>
              <p class="text-sm text-emerald-600 font-medium">RM ${parseFloat(u.unit_price).toFixed(2)} / malam</p>
            </div>
            <div class="flex gap-2">
              <button onclick="showEditUnitModal('${u.__backendId}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">‚úèÔ∏è</button>
              <button onclick="showSpecialPriceModal('${u.__backendId}')" class="p-2 bg-yellow-100 text-yellow-600 rounded-lg hover:bg-yellow-200">üìÖ</button>
              <button onclick="confirmDeleteUnit('${u.__backendId}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">üóë</button>
            </div>
          </div>
        </div>
      `).join('');
        }

        function showAddUnitModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üè† Tambah Unit Baru</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nama Unit</label>
              <input type="text" id="unit-name-input" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Cth: Unit A">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kapasiti (orang)</label>
              <input type="number" id="unit-capacity-input" min="1" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="10">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Harga per Malam (RM)</label>
              <input type="number" id="unit-price-input" min="0" step="0.01" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="150.00">
            </div>
            <div class="flex gap-3">
              <button onclick="addUnit()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">
                + Tambah
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
                Batal
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function addUnit() {
            const name = document.getElementById('unit-name-input').value.trim();
            const capacity = document.getElementById('unit-capacity-input').value;
            const price = document.getElementById('unit-price-input').value;

            if (!name || !capacity || !price) {
                showToast('Sila lengkapkan semua maklumat', 'error');
                return;
            }

            if (units.length >= 50) {
                showToast('Had maksimum unit telah dicapai', 'error');
                return;
            }

            setLoading(true);
            const result = await createRecord({
                type: 'unit',
                unit_name: name,
                unit_capacity: parseInt(capacity),
                unit_price: parseFloat(price),
                special_dates: '{}',
                created_at: new Date().toISOString()
            });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Unit berjaya ditambah', 'success');
            } else {
                showToast('Ralat menambah unit', 'error');
            }
        }

        function showEditUnitModal(unitId) {
            const unit = units.find(u => u.__backendId === unitId);
            if (!unit) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">‚úèÔ∏è Kemaskini Unit</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nama Unit</label>
              <input type="text" id="edit-unit-name" value="${unit.unit_name}" class="w-full p-3 border-2 border-gray-200 rounded-xl">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kapasiti (orang)</label>
              <input type="number" id="edit-unit-capacity" value="${unit.unit_capacity}" min="1" class="w-full p-3 border-2 border-gray-200 rounded-xl">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Harga per Malam (RM)</label>
              <input type="number" id="edit-unit-price" value="${unit.unit_price}" min="0" step="0.01" class="w-full p-3 border-2 border-gray-200 rounded-xl">
            </div>
            <div class="flex gap-3">
              <button onclick="updateUnit('${unitId}')" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">
                üíæ Simpan
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
                Batal
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function updateUnit(unitId) {
            const unit = units.find(u => u.__backendId === unitId);
            if (!unit) return;

            const name = document.getElementById('edit-unit-name').value.trim();
            const capacity = document.getElementById('edit-unit-capacity').value;
            const price = document.getElementById('edit-unit-price').value;

            if (!name || !capacity || !price) {
                showToast('Sila lengkapkan semua maklumat', 'error');
                return;
            }

            setLoading(true);
            const result = await updateRecord({
                ...unit,
                unit_name: name,
                unit_capacity: parseInt(capacity),
                unit_price: parseFloat(price)
            });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Unit berjaya dikemaskini', 'success');
            } else {
                showToast('Ralat mengemaskini unit', 'error');
            }
        }

        function showSpecialPriceModal(unitId) {
            const unit = units.find(u => u.__backendId === unitId);
            if (!unit) return;

            const specialDates = unit.special_dates ? JSON.parse(unit.special_dates) : {};

            // Convert dates to ranges for better display
            const specialRanges = [];
            const processedDates = new Set();
            const sortedDates = Object.keys(specialDates).sort();

            sortedDates.forEach((date) => {
                if (processedDates.has(date)) return;

                let startDate = new Date(date);
                let endDate = new Date(date);
                const priceValue = parseFloat(specialDates[date]);

                // Look for consecutive dates with same price
                let nextDate = new Date(startDate);
                nextDate.setDate(nextDate.getDate() + 1);
                let nextDateKey = formatDateKey(nextDate);

                while (specialDates[nextDateKey] && parseFloat(specialDates[nextDateKey]) === priceValue) {
                    endDate = new Date(nextDate);
                    processedDates.add(nextDateKey);
                    nextDate.setDate(nextDate.getDate() + 1);
                    nextDateKey = formatDateKey(nextDate);
                }

                specialRanges.push({
                    start: formatDateKey(startDate),
                    end: formatDateKey(endDate),
                    price: priceValue
                });

                processedDates.add(date);
            });

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üìÖ Harga Khas - ${unit.unit_name}</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tarikh Mula</label>
              <input type="date" id="special-date-start" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tarikh Akhir</label>
              <input type="date" id="special-date-end" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Harga Khas (RM)</label>
              <input type="number" id="special-price" min="0" step="0.01" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500" placeholder="200.00">
            </div>
            <button onclick="addSpecialPriceRange('${unitId}')" class="w-full py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700 transition">
              ‚ûï Tambah Julat Harga Khas
            </button>

            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-2">üìã Senarai Harga Khas:</h4>
              <div id="special-dates-list" class="space-y-2 max-h-64 overflow-y-auto">
                ${specialRanges.length > 0 ? specialRanges.map((range) => {
                const isSingleDay = range.start === range.end;
                const days = Math.ceil((new Date(range.end) - new Date(range.start)) / (1000 * 60 * 60 * 24)) + 1;
                return `
                  <div class="flex justify-between items-start bg-gradient-to-r from-emerald-50 to-blue-50 p-3 rounded-lg text-sm border-2 border-emerald-200 hover:shadow-md transition">
                    <div class="flex-1">
                      <div class="font-medium text-gray-800 mb-1">
                        ${isSingleDay ?
                        `üìÖ ${formatDisplayDate(new Date(range.start))}` :
                        `üìÖ ${formatDisplayDate(new Date(range.start))} ‚ûú ${formatDisplayDate(new Date(range.end))}`
                    }
                      </div>
                      <div class="text-emerald-700 font-bold text-base">
                        üí∞ RM ${range.price.toFixed(2)}
                      </div>
                      ${!isSingleDay ? `<div class="text-xs text-gray-600 mt-1">
                        ‚è±Ô∏è ${days} hari
                      </div>` : ''}
                    </div>
                    <button onclick="removeSpecialPriceRange('${unitId}', '${range.start}', '${range.end}')" 
                      class="text-red-500 hover:text-red-700 hover:bg-red-100 p-2 rounded-lg transition ml-2" 
                      title="Padam julat ini">
                      üóëÔ∏è
                    </button>
                  </div>
                `;
            }).join('') : '<p class="text-gray-500 text-sm p-4 text-center bg-gray-50 rounded-lg">üì≠ Tiada harga khas ditetapkan</p>'}
              </div>
            </div>

            <button onclick="this.closest('.modal-overlay').remove()" class="w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition">
              Tutup
            </button>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function addSpecialPriceRange(unitId) {
            const unit = units.find(u => u.__backendId === unitId);
            if (!unit) return;

            const startDate = document.getElementById('special-date-start').value;
            const endDate = document.getElementById('special-date-end').value;
            const price = document.getElementById('special-price').value;

            if (!startDate || !endDate || !price) {
                showToast('Sila lengkapkan tarikh mula, tarikh akhir dan harga', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) {
                showToast('Tarikh mula mesti lebih awal dari tarikh akhir', 'error');
                return;
            }

            const specialDates = unit.special_dates ? JSON.parse(unit.special_dates) : {};

            // Add all dates in the range
            let currentDate = new Date(start);
            while (currentDate <= end) {
                const dateKey = formatDateKey(currentDate);
                specialDates[dateKey] = parseFloat(price);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            setLoading(true);
            const result = await updateRecord({
                ...unit,
                special_dates: JSON.stringify(specialDates)
            });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showSpecialPriceModal(unitId);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                showToast(`‚úÖ Harga khas ${days} hari berjaya ditambah`, 'success');
            } else {
                showToast('Ralat menambah harga khas', 'error');
            }
        }

        async function removeSpecialPriceRange(unitId, startDate, endDate) {
            const unit = units.find(u => u.__backendId === unitId);
            if (!unit) return;

            const specialDates = unit.special_dates ? JSON.parse(unit.special_dates) : {};

            // Remove all dates in the range
            const start = new Date(startDate);
            const end = new Date(endDate);
            let currentDate = new Date(start);

            while (currentDate <= end) {
                const dateKey = formatDateKey(currentDate);
                delete specialDates[dateKey];
                currentDate.setDate(currentDate.getDate() + 1);
            }

            setLoading(true);
            const result = await updateRecord({
                ...unit,
                special_dates: JSON.stringify(specialDates)
            });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showSpecialPriceModal(unitId);
                showToast('‚úÖ Julat harga khas berjaya dibuang', 'success');
            } else {
                showToast('Ralat membuang harga khas', 'error');
            }
        }

        function confirmDeleteUnit(unitId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-3xl">‚ö†Ô∏è</span>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">Padam Unit?</h3>
          <p class="text-gray-600 mb-6">Semua tempahan berkaitan unit ini juga akan terjejas.</p>
          <div class="flex gap-3">
            <button onclick="deleteUnit('${unitId}')" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">
              Padam
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
              Batal
            </button>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function deleteUnit(unitId) {
            const unit = units.find(u => u.__backendId === unitId);
            if (!unit) return;

            setLoading(true);
            const result = await deleteRecord(unit);
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Unit berjaya dipadam', 'success');
            } else {
                showToast('Ralat memadam unit', 'error');
            }
        }

        // ==================== ADMIN MANAGEMENT ====================
        function renderAdminsList() {
            const container = document.getElementById('admins-list');

            container.innerHTML = admins.map(a => `
        <div class="border rounded-xl p-4 hover:shadow-md transition">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold text-gray-800">${a.admin_id}</h4>
              <p class="text-sm text-gray-600">${a.admin_role === 'superadmin' ? 'üëë Super Admin' : 'üë§ Admin'}</p>
            </div>
            ${a.admin_role !== 'superadmin' ? `
              <button onclick="confirmDeleteAdmin('${a.__backendId}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">üóë</button>
            ` : ''}
          </div>
        </div>
      `).join('');
        }

        function showAddAdminModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üë§ Tambah Admin Baru</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ID Admin</label>
              <input type="text" id="new-admin-id" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Masukkan ID">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kata Laluan</label>
              <input type="password" id="new-admin-password" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Masukkan kata laluan">
            </div>
            <div class="flex gap-3">
              <button onclick="addAdmin()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">
                + Tambah
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
                Batal
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function addAdmin() {
            const id = document.getElementById('new-admin-id').value.trim();
            const password = document.getElementById('new-admin-password').value;

            if (!id || !password) {
                showToast('Sila lengkapkan semua maklumat', 'error');
                return;
            }

            if (admins.some(a => a.admin_id === id)) {
                showToast('ID Admin sudah wujud', 'error');
                return;
            }

            setLoading(true);
            const result = await createRecord({
                type: 'admin',
                admin_id: id,
                admin_password: password,
                admin_role: 'admin',
                created_at: new Date().toISOString()
            });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Admin berjaya ditambah', 'success');
            } else {
                showToast('Ralat menambah admin', 'error');
            }
        }

        function confirmDeleteAdmin(adminId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
          <h3 class="text-lg font-bold text-gray-800 mb-2">Padam Admin?</h3>
          <div class="flex gap-3 mt-4">
            <button onclick="deleteAdmin('${adminId}')" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">
              Padam
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
              Batal
            </button>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function deleteAdmin(adminId) {
            const admin = admins.find(a => a.__backendId === adminId);
            if (!admin) return;

            setLoading(true);
            const result = await deleteRecord(admin);
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Admin berjaya dipadam', 'success');
            } else {
                showToast('Ralat memadam admin', 'error');
            }
        }

        // ==================== PROMO MANAGEMENT ====================
        function renderPromosList() {
            const container = document.getElementById('promos-list');
            const noPromos = document.getElementById('no-promos');

            if (promos.length === 0) {
                container.innerHTML = '';
                noPromos.classList.remove('hidden');
                return;
            }

            noPromos.classList.add('hidden');

            container.innerHTML = promos.map(p => `
        <div class="border rounded-xl p-4 hover:shadow-md transition">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold text-gray-800">${p.promo_code}</h4>
              <p class="text-sm text-emerald-600">Diskaun: RM ${parseFloat(p.promo_value).toFixed(2)}</p>
              <p class="text-xs ${p.promo_active ? 'text-green-600' : 'text-red-600'}">${p.promo_active ? '‚úì Aktif' : '‚úó Tidak Aktif'}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="togglePromo('${p.__backendId}')" class="p-2 ${p.promo_active ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'} rounded-lg hover:opacity-80">
                ${p.promo_active ? '‚è∏' : '‚ñ∂'}
              </button>
              <button onclick="confirmDeletePromo('${p.__backendId}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">üóë</button>
            </div>
          </div>
        </div>
      `).join('');
        }

        function showAddPromoModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üéüÔ∏è Tambah Kod Promo</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kod Promo</label>
              <input type="text" id="new-promo-code" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Cth: DISKAUN50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nilai Diskaun (RM)</label>
              <input type="number" id="new-promo-value" min="0" step="0.01" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="50.00">
            </div>
            <div class="flex gap-3">
              <button onclick="addPromo()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">
                + Tambah
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
                Batal
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function addPromo() {
            const code = document.getElementById('new-promo-code').value.trim().toUpperCase();
            const value = document.getElementById('new-promo-value').value;

            if (!code || !value) {
                showToast('Sila lengkapkan semua maklumat', 'error');
                return;
            }

            if (promos.some(p => p.promo_code === code)) {
                showToast('Kod promo sudah wujud', 'error');
                return;
            }

            setLoading(true);
            const result = await createRecord({
                type: 'promo',
                promo_code: code,
                promo_value: parseFloat(value),
                promo_active: true,
                created_at: new Date().toISOString()
            });
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Kod promo berjaya ditambah', 'success');
            } else {
                showToast('Ralat menambah kod promo', 'error');
            }
        }

        async function togglePromo(promoId) {
            const promo = promos.find(p => p.__backendId === promoId);
            if (!promo) return;

            setLoading(true);
            const result = await updateRecord({
                ...promo,
                promo_active: !promo.promo_active
            });
            setLoading(false);

            if (result.isOk) {
                showToast(`Kod promo ${promo.promo_active ? 'dinyahaktifkan' : 'diaktifkan'}`, 'success');
            } else {
                showToast('Ralat mengemaskini kod promo', 'error');
            }
        }

        function confirmDeletePromo(promoId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 text-center">
          <h3 class="text-lg font-bold text-gray-800 mb-2">Padam Kod Promo?</h3>
          <div class="flex gap-3 mt-4">
            <button onclick="deletePromo('${promoId}')" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">
              Padam
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
              Batal
            </button>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function deletePromo(promoId) {
            const promo = promos.find(p => p.__backendId === promoId);
            if (!promo) return;

            setLoading(true);
            const result = await deleteRecord(promo);
            setLoading(false);

            if (result.isOk) {
                document.querySelector('.modal-overlay').remove();
                showToast('Kod promo berjaya dipadam', 'success');
            } else {
                showToast('Ralat memadam kod promo', 'error');
            }
        }

        // ==================== SYSTEM SETTINGS ====================
        function loadSystemSettings() {
            if (systemSettings.admin_whatsapp) {
                document.getElementById('admin-whatsapp-number').value = systemSettings.admin_whatsapp;
            }
            if (systemSettings.telegram_group_id) {
                document.getElementById('telegram-group-id').value = systemSettings.telegram_group_id;
            }
            if (systemSettings.telegram_bot_token) {
                document.getElementById('telegram-bot-token').value = systemSettings.telegram_bot_token;
            }
        }

        async function saveSystemSettings() {
            const adminWhatsApp = document.getElementById('admin-whatsapp-number').value.trim();
            const telegramGroupId = document.getElementById('telegram-group-id').value.trim();
            const telegramBotToken = document.getElementById('telegram-bot-token').value.trim();

            setLoading(true);

            if (systemSettings.__backendId) {
                const result = await updateRecord({
                    ...systemSettings,
                    admin_whatsapp: adminWhatsApp,
                    telegram_group_id: telegramGroupId,
                    telegram_bot_token: telegramBotToken
                });
                if (result.isOk) {
                    showToast('Tetapan berjaya disimpan', 'success');
                } else {
                    showToast('Ralat menyimpan tetapan', 'error');
                }
            } else {
                const result = await createRecord({
                    type: 'settings',
                    admin_whatsapp: adminWhatsApp,
                    telegram_group_id: telegramGroupId,
                    telegram_bot_token: telegramBotToken,
                    created_at: new Date().toISOString()
                });
                if (result.isOk) {
                    showToast('Tetapan berjaya disimpan', 'success');
                } else {
                    showToast('Ralat menyimpan tetapan', 'error');
                }
            }

            setLoading(false);
        }

        function showProfileSettings() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-overlay';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">‚öôÔ∏è Tetapan Profil</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ID Admin</label>
              <input type="text" value="${currentAdmin.admin_id}" disabled class="w-full p-3 border-2 border-gray-200 rounded-xl bg-gray-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kata Laluan Baru</label>
              <input type="password" id="new-password" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Masukkan kata laluan baru">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sahkan Kata Laluan</label>
              <input type="password" id="confirm-password" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Sahkan kata laluan">
            </div>
            <div class="flex gap-3">
              <button onclick="changePassword()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">
                üíæ Simpan
              </button>
              <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300">
                Batal
              </button>
            </div>
          </div>
        </div>
      `;
            document.getElementById('modals-container').appendChild(modal);
        }

        async function changePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!newPassword) {
                showToast('Sila masukkan kata laluan baru', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('Kata laluan tidak sepadan', 'error');
                return;
            }

            setLoading(true);
            const result = await updateRecord({
                ...currentAdmin,
                admin_password: newPassword
            });
            setLoading(false);

            if (result.isOk) {
                currentAdmin.admin_password = newPassword;
                document.querySelector('.modal-overlay').remove();
                showToast('Kata laluan berjaya dikemaskini', 'success');
            } else {
                showToast('Ralat mengemaskini kata laluan', 'error');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function renderCurrentView() {
            const bookingPanel = document.getElementById('booking-panel');
            const adminDashboard = document.getElementById('admin-dashboard');

            if (!bookingPanel.classList.contains('hidden')) {
                renderUnitSelect();
                if (selectedUnit) {
                    renderCalendar();
                }
            }

            if (!adminDashboard.classList.contains('hidden')) {
                renderAdminDashboard();
                const activeTab = document.querySelector('.admin-tab.tab-active');
                if (activeTab) {
                    const tab = activeTab.dataset.tab;
                    if (tab === 'bookings') renderBookingsTable();
                    if (tab === 'units') renderUnitsList();
                    if (tab === 'admins') renderAdminsList();
                    if (tab === 'promos') renderPromosList();
                    if (tab === 'dashboard') {
                        renderDatePickerCalendar();
                        renderAdminCalendar();
                    }
                }
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            toast.className = `toast px-4 py-3 rounded-xl text-white shadow-lg ${colors[type] || colors.info}`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function setLoading(loading) {
            isLoading = loading;
        }

        // Initialize
        updateTotalGuests();
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9bfb6b20a7c1ace9',t:'MTc2ODcxMTI3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
